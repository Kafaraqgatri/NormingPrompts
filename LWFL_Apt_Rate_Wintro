import os
import time
import pandas as pd
from dotenv import load_dotenv
from openai import OpenAI

# --------------------------------------------------------------------------
# 0.  Config & client
# --------------------------------------------------------------------------
load_dotenv(r"C:\Users\Cagi\API.env")  # .env must define OPENAI_API_KEY
client = OpenAI(api_key=os.environ["OPENAI_API_KEY"])

MODEL_NAME = "gpt-4o"      # GPT-4o (cheaper & faster than 4-turbo)
USE_INTRO  = True          # False → ignore the INTRO sentence

# --------------------------------------------------------------------------
# 1.  Prompt templates
# --------------------------------------------------------------------------
SYSTEM_MSG = (
    "You are an adult English speaker rating metaphors.\n"
    "Return ONLY a single integer from 1 to 5 (no words, no punctuation)."
)

USER_TEMPLATE = (
    "{maybe_intro}"
    "Metaphor: \"{met}\"\n\n"
    "Rate how APT the metaphor is at conveying the concept, where "
    "1 = not apt at all and 5 = extremely apt.\n\n"
    "Number only:"
)

def make_user_msg(intro: str | None, metaphor: str) -> str:
    intro_piece = f"Background: {intro.strip()}\n\n" if (USE_INTRO and intro) else ""
    return USER_TEMPLATE.format(maybe_intro=intro_piece, met=metaphor)

# --------------------------------------------------------------------------
# 2.  Helper: get integer rating
# --------------------------------------------------------------------------
def rate_aptness(metaphor: str, intro: str | None, retries: int = 3) -> int | None:
    for _ in range(retries):
        try:
            resp = client.chat.completions.create(
                model=MODEL_NAME,
                temperature=0,
                max_tokens=1,  # expect a single-token answer
                messages=[
                    {"role": "system", "content": SYSTEM_MSG},
                    {"role": "user",   "content": make_user_msg(intro, metaphor)},
                ],
            )
            rating = int(resp.choices[0].message.content.strip())
            if 1 <= rating <= 5:
                return rating
        except Exception as e:
            print("⚠️ retrying after error:", e)
            time.sleep(1)
    return None

# --------------------------------------------------------------------------
# 3.  Load Excel sheet & collect ratings
# --------------------------------------------------------------------------
excel_path = r"C:\Users\Cagi\Desktop\LWfl\Stimuli\Pavia Learning Study - WordList.xlsx"
df = pd.read_excel(
    excel_path,
    sheet_name="GPT",
    usecols=["INTRO", "MET"]
)

ratings = []
for idx, row in df.iterrows():
    intro = row["INTRO"]
    met   = row["MET"]
    r = rate_aptness(met, intro)
    ratings.append(r)
    print(f"{idx+1:3d}. {met[:50]:50s} → {r}")
    time.sleep(0.3)  # gentle pacing

# --------------------------------------------------------------------------
# 4.  Save results
# --------------------------------------------------------------------------
df["RATING"] = ratings
out_path = r"C:\Users\Cagi\Desktop\LWfl\Stimuli\Pavia Learning Study - WordList_rated.xlsx"
df.to_excel(out_path, index=False)
print(f"\nAll done! Ratings saved to:\n  {out_path}")
